#!/usr/bin/env python3
"""
Script de test local pour vÃ©rifier que l'API fonctionne
ExÃ©cutez : python test_local.py
"""

import sys
import os

# Ajouter le dossier api au path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'api'))

from subtitles import get_subtitles, get_available_languages, SubtitleError

def test_video_id(video_id):
    """Teste l'extraction de sous-titres pour un ID vidÃ©o"""
    print(f"\n{'='*60}")
    print(f"Test de la vidÃ©o : {video_id}")
    print(f"{'='*60}\n")
    
    # Test 1 : Langues disponibles
    print("ğŸ” RÃ©cupÃ©ration des langues disponibles...")
    try:
        languages = get_available_languages(video_id)
        print(f"âœ… {len(languages)} langue(s) trouvÃ©e(s):")
        # Afficher seulement les 5 premiÃ¨res pour Ã©viter le spam
        for lang in languages[:5]:
            auto = " (Auto-gÃ©nÃ©rÃ©)" if lang['isAutoGenerated'] else ""
            print(f"   - {lang['name']} ({lang['code']}){auto}")
        if len(languages) > 5:
            print(f"   ... et {len(languages) - 5} autres langues")
    except SubtitleError as e:
        print(f"âŒ Erreur : {e}")
        return False
    
    print()
    
    # IMPORTANT : Attendre entre chaque requÃªte pour Ã©viter le rate limiting
    import time
    time.sleep(2)
    
    # Test 2 : Extraction TXT
    print("ğŸ“„ Test format TXT...")
    try:
        result = get_subtitles(video_id, 'txt', 'fr')
        preview = result['content'][:200] + "..." if len(result['content']) > 200 else result['content']
        print(f"âœ… TXT rÃ©cupÃ©rÃ© ({len(result['content'])} caractÃ¨res)")
        print(f"   AperÃ§u : {preview}")
        print(f"   Langue : {result['language']}")
    except SubtitleError as e:
        print(f"âŒ Erreur TXT : {e}")
    
    print()
    time.sleep(2)  # Attendre encore
    
    # Test 3 : Extraction SRT (optionnel, commentÃ© pour Ã©viter rate limit)
    # print("ğŸ¬ Test format SRT...")
    # try:
    #     result = get_subtitles(video_id, 'srt', 'fr')
    #     lines = result['content'].split('\n')[:10]
    #     print(f"âœ… SRT rÃ©cupÃ©rÃ© ({result['lineCount']} lignes)")
    # except SubtitleError as e:
    #     print(f"âŒ Erreur SRT : {e}")
    
    return True

def main():
    """Fonction principale"""
    print("\n" + "="*60)
    print("ğŸ§ª TEST DE L'API SOUS-TITRES YOUTUBE")
    print("="*60)
    
    # VidÃ©os de test - RÃ‰DUITES pour Ã©viter le rate limiting
    test_videos = [
        {
            'id': '0ZZ6WpkoAww',
            'name': 'Votre vidÃ©o de test'
        }
    ]
    
    success_count = 0
    
    for video in test_videos:
        if test_video_id(video['id']):
            success_count += 1
    
    # RÃ©sumÃ©
    print(f"\n{'='*60}")
    print(f"ğŸ“Š RÃ‰SUMÃ‰ DES TESTS")
    print(f"{'='*60}")
    print(f"âœ… SuccÃ¨s : {success_count}/{len(test_videos)}")
    print(f"âŒ Ã‰checs : {len(test_videos) - success_count}/{len(test_videos)}")
    
    if success_count == len(test_videos):
        print("\nğŸ‰ Tous les tests ont rÃ©ussi ! PrÃªt pour le dÃ©ploiement.")
        return 0
    else:
        print("\nâš ï¸  Certains tests ont Ã©chouÃ©. VÃ©rifiez les erreurs ci-dessus.")
        return 1

if __name__ == '__main__':
    exit(main())